#!/usr/bin/python2
# -*- coding: utf-8 -*-
import multiprocessing

def action_dean(pipe):
	import httplib, urllib, re
	import xml.dom.minidom as xmldom

	username, password = None, None
	conn = httplib.HTTPSConnection('iaaa.pku.edu.cn')
	conn.request('POST', '/iaaa/oauth.jsp', urllib.urlencode({'appID': 'dean', 'appName': '北京大学教务部网上学生服务中心', 'redirectUrl': 'http://dean.pku.edu.cn/student/center2.php'}), {'Content-Type': 'application/x-www-form-urlencoded'})
	res = conn.getresponse()
	jsessionid = re.search(r'JSESSIONID=([^;]+)', res.getheader('Set-Cookie')).group(1)
	res.read()
	username, password = pipe.recv().split('\n')
	for i in range(0, 2):
		try:
			conn.request('POST', '/iaaa/oauthlogin.do', urllib.urlencode({'appid': 'dean', 'userName': username, 'password': password, 'redirUrl': 'http://dean.pku.edu.cn/student/center2.php'}), {'Cookie': 'JSESSIONID=%s' % jsessionid, 'Content-Type': 'application/x-www-form-urlencoded'})
			break
		except:
			conn.close()
			conn = httplib.HTTPSConnection('iaaa.pku.edu.cn')
	res = conn.getresponse()
	s = res.read()
	conn.close()
	if s.find('"success":true') == -1:
		err = re.search(r'"msg":"([^"]*)"', s).group(1)
		print 'Dean error:', err
		pipe.send('error')
		return
	token = re.search('"token":"(\w+)"', s).group(1)
	conn = httplib.HTTPConnection('dean.pku.edu.cn')
	conn.request('GET', '/student/center2.php?token=%s' % token)
	res = conn.getresponse()
	phpsessid = re.search(r'PHPSESSID=([^;]+)', res.getheader('Set-Cookie')).group(1)
	res.read()
	conn.request('GET', '/student/grade.php?PHPSESSID=%s' % phpsessid, headers = {'Cookie': 'PHPSESSID=%s' % phpsessid })
	res = conn.getresponse()
	s = res.read().decode('gbk').encode('utf-8')
	t = re.sub(r'align=center colspan=5', '', re.sub(r'(<tr.*?>(<td.*?>.*?</td>)*)', r'\1</tr>', re.search(r'<table.*?>(((<tr>|<tr type=\'text/css\' style=\'color:ff0000\'>).*?)*<tr type=\'text/css\' >.*?)*</table>', s).group(1)))
	t = re.sub(r'&(\w+[^;])', r'&amp;\1', t) # ,b dean
	dom = xmldom.parseString('<table>' + t + '</table>')
	deandata = map(lambda y: map(lambda x: '' if x.firstChild is None else x.firstChild.data.strip(), y.childNodes[2: ]), dom.firstChild.childNodes[: -1])
	pipe.send(repr((deandata, dom.firstChild.childNodes[-1].childNodes[3].firstChild.firstChild.data.strip())))
	conn.request('GET', '/student/exit.php?PHPSESSID=%s' % phpsessid, headers = {'Cookie': 'PHPSESSID=%s' % phpsessid })
	conn.getresponse().read()
	conn.close()

if __name__ == '__main__':
	deanpair = multiprocessing.Pipe()
	deanp = multiprocessing.Process(target = action_dean, args = (deanpair[1], ))
	deanp.start()

	import getpass, sys
	sys.stderr.write('Username: ')
	username = raw_input()
	password = getpass.getpass()
	deanpair[0].send(username + '\n' + password)
	deandata = deanpair[0].recv()
	if deandata == 'error':
		deanp.join()
		quit(1)
	deandata, deangpa = eval(deandata)

	for item in deandata:
		while len(item[3].encode('gbk')) > 20: item[3] = item[3][: -1]
		item[2] = item[2] + ' ' * (10 - len(item[2].encode('gbk')))
		item[3] = item[3] + ' ' * (20 - len(item[3].encode('gbk')))
		print "%8s %4s   %s %s %5s %6s" % tuple(item)
	print '当前平均绩点:', deangpa

	deanp.join()
